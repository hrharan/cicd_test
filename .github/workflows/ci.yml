name: Full CI/CD Pipeline

on: [push]

jobs:
  # JOB 1: THE FILTER (CI)
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        pip install -r requirements.txt
    - name: Run tests
      run: pytest

    # NEW STEP: Verify Docker Build
    - name: Build Docker Image
      run: docker build -t my-app:latest

  # JOB 2: THE DELIVERY (CD)
  deploy:
    runs-on: ubuntu-latest
    # VITAL: This tells GitHub to WAIT for the test job
    needs: build-and-test 
    
    steps:
      # Logic: Only run this step if we are on the 'main' branch
      - name: Deploy to Staging
        if: github.ref == 'refs/heads/main'
        run: |
          echo "âœ… Tests passed. Deploying to Staging..."
          # We use curl to hit the secret URL. The & wait prevents hanging.
          curl "${{ secrets.RENDER_DEPLOY_HOOK_STAGING }}"
      
      # Logic: Only run this step if we push a Tag (like v1.0)
      - name: Deploy to Production
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "ðŸš€ PRODUCTION RELEASE DETECTED!"
          echo "Deploying to Production Server..."
          # Note: In a real setup, you'd have a second Secret for the Prod URL
          # curl "${{ secrets.RENDER_DEPLOY_HOOK_PROD }}"
